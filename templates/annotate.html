{% extends "base.html" %}

{% block title %}Annotate - FreeFlow{% endblock %}

{% block content %}
<div class="annotate-container">
    <div class="annotate-header">
        <button class="btn btn-secondary" onclick="location.href='/project/{{ project_id }}'">‚Üê Back</button>
        <div class="image-nav">
            <button class="btn-icon" onclick="previousImage()" id="prevBtn">‚Üê</button>
            <span id="imageCounter">0 / 0</span>
            <button class="btn-icon" onclick="nextImage()" id="nextBtn">‚Üí</button>
        </div>
        <div class="annotate-actions">
            <button class="btn btn-secondary" onclick="toggleLabelAssist()" id="assistBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2"/>
                </svg>
                Label Assist
            </button>
            <button class="btn btn-primary" onclick="saveAnnotations()">Save</button>
        </div>
    </div>

    <div class="annotate-layout">
        <div class="sidebar left">
            <div class="sidebar-section">
                <h3>Classes</h3>
                <div id="classesList" class="classes-list">
                    <!-- Classes will be loaded here -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Annotations <span id="annotationCount">0</span></h3>
                <div id="annotationsList" class="annotations-list">
                    <!-- Annotations will be listed here -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Layers</h3>
                <div class="layers-toggle">
                    <label>
                        <input type="checkbox" checked onchange="toggleAnnotationVisibility()">
                        Show Annotations
                    </label>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="annotationCanvas"></canvas>
            <img id="imageElement" style="display: none;">
            
            <!-- Label Assist Panel -->
            <div id="labelAssistPanel" class="assist-panel" style="display: none;">
                <div class="assist-header">
                    <h4>Label Assist</h4>
                    <button class="close-btn" onclick="closeLabelAssist()">‚úï</button>
                </div>
                <div class="assist-body">
                    <p>Select the classes to use while labeling.</p>
                    <div id="assistClassesList">
                        <!-- Classes for assist will be loaded here -->
                    </div>
                    <div class="assist-settings">
                        <label>
                            Confidence:
                            <input type="range" id="confidenceSlider" min="0" max="100" value="50">
                            <span id="confidenceValue">50%</span>
                        </label>
                        <label>
                            Overlap:
                            <input type="range" id="overlapSlider" min="0" max="100" value="50">
                            <span id="overlapValue">50%</span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="runLabelAssist()">Run Assist</button>
                </div>
            </div>

            <div class="canvas-controls">
                <button class="btn-icon" onclick="zoomOut()">‚àí</button>
                <span id="zoomLevel">100%</span>
                <button class="btn-icon" onclick="zoomIn()">+</button>
                <button class="btn-icon" onclick="resetZoom()">Reset</button>
            </div>
        </div>

        <div class="sidebar right">
            <div class="sidebar-section">
                <h3>Settings</h3>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: rgba(124, 58, 237, 0.1); border-radius: 0.5rem; margin-bottom: 1rem;">
                    <input type="checkbox" id="autoSaveCheckbox" onchange="toggleAutoSave()" style="cursor: pointer;" checked>
                    <span style="font-size: 0.875rem;">Auto-save on navigation</span>
                </label>
                
                <div style="padding: 0.75rem; background: rgba(99, 102, 241, 0.05); border-radius: 0.5rem; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <h4 style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 0 0 0.5rem 0; text-transform: uppercase; letter-spacing: 0.5px;">üí° Tip</h4>
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin: 0; line-height: 1.4;">
                        Hold <kbd style="padding: 0.1rem 0.3rem; background: var(--surface); border: 1px solid var(--border); border-radius: 0.25rem; font-size: 0.7rem; font-family: monospace;">Shift</kbd> while drawing to create a new box over existing annotations
                    </p>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>ü§ñ SAM2 Segmentation</h3>
                
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border-radius: 0.5rem; margin-bottom: 1rem;">
                    <input type="checkbox" id="sam2EnabledCheckbox" onchange="toggleSAM2Mode()" style="cursor: pointer;">
                    <span style="font-size: 0.875rem;">Enable SAM2 Mode</span>
                </label>
                
                <div id="sam2Controls" style="display: none;">
                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">Model</label>
                        <select id="sam2ModelSelect" onchange="changeSAM2Model()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--surface);">
                            <option value="">Loading models...</option>
                        </select>
                        <div id="sam2ModelDownload" style="display: none; margin-top: 0.5rem;">
                            <button onclick="downloadSAM2Model()" style="width: 100%; padding: 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.75rem;">
                                üì• Download Model
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">Mode</label>
                        <select id="sam2ModeSelect" onchange="updateSAM2Mode()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--surface);">
                            <option value="hover">Hover Preview (Point)</option>
                            <option value="box">Box to Polygon (Press S)</option>
                            <option value="auto">Auto Box to Polygon</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">
                            Polygon Detail: <span id="sam2DetailValue">Medium</span>
                        </label>
                        <input type="range" id="sam2DetailSlider" min="0" max="10" value="5" step="0.5" onchange="updateSAM2Detail()" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.625rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            <span>Coarse</span>
                            <span>Fine</span>
                        </div>
                    </div>
                    
                    <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.05); border-radius: 0.5rem; border: 1px solid rgba(139, 92, 246, 0.2); margin-top: 0.75rem;">
                        <h4 style="font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); margin: 0 0 0.5rem 0; text-transform: uppercase; letter-spacing: 0.5px;">üí° How to Use</h4>
                        <ul style="font-size: 0.65rem; color: var(--text-secondary); margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                            <li><strong>Hover:</strong> Move mouse to preview, click to save polygon</li>
                            <li><strong>Box:</strong> Draw box, press <kbd style="padding: 0.1rem 0.3rem; background: var(--surface); border: 1px solid var(--border); border-radius: 0.25rem; font-size: 0.6rem;">S</kbd> to convert</li>
                            <li><strong>Auto:</strong> Draw box and it auto-converts to polygon</li>
                            <li><strong>Detail:</strong> Adjust polygon complexity</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>History</h3>
                <div class="history-actions">
                    <button class="btn-icon" onclick="undo()" title="Undo">‚Ü∂</button>
                    <button class="btn-icon" onclick="redo()" title="Redo">‚Ü∑</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Tags</h3>
                <p class="empty-state">No Tags Applied</p>
            </div>
        </div>
    </div>
</div>

<script>
    const PROJECT_ID = {{ project_id }};
</script>
<script src="{{ url_for('static', filename='js/annotate.js') }}?v={{ range(1, 9999999) | random }}"></script>
{% endblock %}

