{% extends "base.html" %}

{% block title %}Training - FreeFlow{% endblock %}

{% block content %}
<div class="container">
    <div class="project-header">
        <div class="breadcrumb">
            <a href="/">Projects</a> / <a href="/project/{{ project_id }}">Project</a> / Training
        </div>
    </div>

    <div class="training-container">
        <div class="training-config">
            <h2>Train YOLO11 Model</h2>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
                Using latest YOLOv11 architecture for state-of-the-art object detection
            </p>

            <div class="form-group">
                <label>Training Location</label>
                <select id="trainingLocation" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text); cursor: pointer;">
                    <option value="local">Local Machine</option>
                    <option value="huggingface">Hugging Face Jobs</option>
                </select>
                <p class="help-text">Choose where to run your training</p>
            </div>

            <div id="hfJobsConfig" style="display: none;">
                <div class="form-group">
                    <label>Hugging Face Username</label>
                    <input type="text" id="hfUsername" placeholder="e.g., your-username" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text);">
                    <p class="help-text">Your Hugging Face username</p>
                </div>

                <div class="form-group">
                    <label>Hugging Face API Key</label>
                    <input type="password" id="hfApiKey" placeholder="hf_..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text);">
                    <p class="help-text">Get your API key from <a href="https://huggingface.co/settings/tokens" target="_blank" style="color: var(--primary-color);">huggingface.co/settings/tokens</a></p>
                </div>

                <div class="form-group">
                    <label>Hardware</label>
                    <select id="hfHardware" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text); cursor: pointer;">
                        <optgroup label="CPU">
                            <option value="cpu-basic">CPU Basic</option>
                            <option value="cpu-upgrade">CPU Upgrade</option>
                        </optgroup>
                        <optgroup label="GPU">
                            <option value="t4-small" selected>T4 Small (Recommended)</option>
                            <option value="t4-medium">T4 Medium</option>
                            <option value="l4x1">L4 x1</option>
                            <option value="l4x4">L4 x4</option>
                            <option value="a10g-small">A10G Small</option>
                            <option value="a10g-large">A10G Large</option>
                            <option value="a10g-largex2">A10G Large x2</option>
                            <option value="a10g-largex4">A10G Large x4</option>
                            <option value="a100-large">A100 Large</option>
                        </optgroup>
                        <optgroup label="TPU">
                            <option value="v5e-1x1">TPU v5e-1x1</option>
                            <option value="v5e-2x2">TPU v5e-2x2</option>
                            <option value="v5e-2x4">TPU v5e-2x4</option>
                        </optgroup>
                    </select>
                    <p class="help-text">Select hardware for your training job</p>
                </div>
            </div>
            
            <div class="form-group">
                <label>Model Name</label>
                <input type="text" id="modelName" placeholder="e.g., baseline-v1, high-precision" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text);">
                <p class="help-text">Give your model a descriptive name</p>
            </div>

            <div class="form-group">
                <label>Model Size</label>
                <select id="modelSize" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text); cursor: pointer;">
                    <option value="n">Nano - Fastest, good for real-time (6.3M params)</option>
                    <option value="s">Small - Balanced speed/accuracy (11.2M params)</option>
                    <option value="m" selected>Medium - Recommended for most uses (20.1M params)</option>
                    <option value="l">Large - High accuracy (25.3M params)</option>
                    <option value="x">X-Large - Maximum accuracy (29.0M params)</option>
                </select>
                <p class="help-text">Larger models are more accurate but slower</p>
            </div>

            <div class="form-group">
                <label>Dataset Version</label>
                <select id="datasetVersionSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text); cursor: pointer;">
                    <option value="">Use all annotated images (auto-split)</option>
                </select>
                <p class="help-text">Select a specific dataset version or use auto-split (70/20/10)</p>
            </div>
            
            <div class="form-group">
                <label>Epochs</label>
                <input type="number" id="epochs" value="100" min="1" max="1000">
                <p class="help-text">Number of training iterations</p>
            </div>

            <div class="form-group">
                <label>Batch Size</label>
                <input type="number" id="batchSize" value="16" min="1" max="64">
                <p class="help-text">Number of images per batch</p>
            </div>

            <div class="form-group">
                <label>Image Size</label>
                <select id="imageSize">
                    <option value="416">416</option>
                    <option value="640" selected>640</option>
                    <option value="1280">1280</option>
                </select>
                <p class="help-text">Input image size for training</p>
            </div>

            <div class="dataset-info">
                <h3>Dataset Info</h3>
                <div class="info-row">
                    <span>Total Images:</span>
                    <span id="totalImages">0</span>
                </div>
                <div class="info-row">
                    <span>Annotated Images:</span>
                    <span id="annotatedImages">0</span>
                </div>
                <div class="info-row">
                    <span>Classes:</span>
                    <span id="classCount">0</span>
                </div>
            </div>

            <button class="btn btn-primary btn-large" onclick="startTraining()" id="trainBtn">
                Start Training
            </button>
        </div>

        <div class="training-monitor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0;">Training Progress</h2>
                <button class="btn btn-secondary" onclick="showConfigPanel()" style="display: none;" id="newTrainingBtn">
                    üéØ New Training
                </button>
            </div>
            
            <div id="trainingStatus" class="training-status">
                <p class="empty-state">No training in progress</p>
            </div>
            
            <div id="stopTrainingContainer" style="display: none; text-align: center; margin-bottom: 1.5rem;">
                <button class="btn" id="stopTrainingBtn" onclick="stopTrainingEarly()" style="background: var(--error); color: white; padding: 0.75rem 2rem; font-size: 0.95rem;">
                    ‚èπÔ∏è Stop After Current Epoch
                </button>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">Training will finish the current epoch and save the model</p>
            </div>

            <div id="trainingCharts" style="display: none;">
                <div class="metrics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="metric-card">
                        <h4>Current Epoch</h4>
                        <p id="currentEpoch">0 / 0</p>
                    </div>
                    <div class="metric-card">
                        <h4>Box Loss</h4>
                        <p id="trainBoxLoss">0.000</p>
                    </div>
                    <div class="metric-card">
                        <h4>Class Loss</h4>
                        <p id="trainClsLoss">0.000</p>
                    </div>
                    <div class="metric-card">
                        <h4>DFL Loss</h4>
                        <p id="trainDflLoss">0.000</p>
                    </div>
                    <div class="metric-card">
                        <h4>Val Box Loss</h4>
                        <p id="valBoxLoss">0.000</p>
                    </div>
                    <div class="metric-card">
                        <h4>Val Class Loss</h4>
                        <p id="valClsLoss">0.000</p>
                    </div>
                    <div class="metric-card">
                        <h4>mAP@50</h4>
                        <p id="map50">0.000</p>
                    </div>
                </div>

                <div class="charts-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="chart-container">
                        <h3>Loss</h3>
                        <canvas id="lossChart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>mAP@50</h3>
                        <canvas id="mapChart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Precision & Recall</h3>
                        <canvas id="precisionRecallChart" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="chart-container">
                        <h3>Learning Rate</h3>
                        <canvas id="lrChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Test Metrics Section -->
            <div id="testMetricsSection" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: var(--card-background); border: 1px solid var(--border); border-radius: 0.75rem;">
                <h3 style="margin-bottom: 1rem; color: var(--text);">üìä Test Set Evaluation</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="metric-card">
                        <h4>Test mAP@50</h4>
                        <p id="testMap50">-</p>
                    </div>
                    <div class="metric-card">
                        <h4>Test Precision</h4>
                        <p id="testPrecision">-</p>
                    </div>
                    <div class="metric-card">
                        <h4>Test Recall</h4>
                        <p id="testRecall">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="training-history">
        <h2>Training Jobs</h2>
        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
            Click on any job to view its progress. Multiple jobs can run simultaneously.
        </p>
        <div id="trainingHistory" class="history-list">
            <!-- Training jobs will be loaded here -->
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const PROJECT_ID = {{ project_id }};
</script>
<script src="{{ url_for('static', filename='js/training.js') }}"></script>
{% endblock %}

